<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Clone - Secure Messaging</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #111b21;
            height: 100vh;
            overflow: hidden;
        }

        /* Auth Screen */
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #00a884 0%, #005c4b 100%);
        }

        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .auth-box h1 {
            color: #00a884;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .auth-box p {
            color: #667781;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .auth-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9edef;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: border-color 0.2s;
        }

        .auth-box input:focus {
            outline: none;
            border-color: #00a884;
        }

        .auth-box button {
            width: 100%;
            padding: 15px;
            background: #00a884;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 10px;
        }

        .auth-box button:hover {
            background: #06cf9c;
        }

        .auth-switch {
            color: #00a884;
            cursor: pointer;
            text-decoration: underline;
            font-size: 14px;
        }

        .error-message {
            background: #ffe5e5;
            color: #f15c6d;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .success-message {
            background: #d1f4dd;
            color: #00a884;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        /* Chat Screen */
        .chat-screen {
            display: none;
            height: 100vh;
        }

        .chat-screen.active {
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 35%;
            min-width: 300px;
            background: #111b21;
            border-right: 1px solid #2a3942;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            background: #202c33;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #00a884;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .user-name {
            color: #e9edef;
            font-size: 16px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: #aebac1;
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
            transition: color 0.2s;
        }

        .icon-btn:hover {
            color: #e9edef;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: #202c33;
            border-bottom: 1px solid #2a3942;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: #8696a0;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            position: relative;
        }

        .tab.active {
            color: #00a884;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #00a884;
        }

        .chat-list, .contacts-list {
            flex: 1;
            overflow-y: auto;
            background: #111b21;
        }

        .contacts-list {
            display: none;
        }

        .contacts-list.active {
            display: block;
        }

        .chat-list.hidden {
            display: none;
        }

        .chat-item, .contact-item {
            display: flex;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #202c33;
            align-items: center;
        }

        .chat-item:hover, .contact-item:hover {
            background: #202c33;
        }

        .chat-item.active {
            background: #2a3942;
        }

        .chat-avatar, .contact-avatar {
            width: 50px;
            height: 50px;
            background: #6b7c85;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
            margin-right: 15px;
            position: relative;
        }

        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #00a884;
            border-radius: 50%;
            border: 2px solid #111b21;
        }

        .chat-details, .contact-details {
            flex: 1;
            overflow: hidden;
        }

        .chat-name, .contact-name {
            color: #e9edef;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .chat-last-message, .contact-status {
            color: #8696a0;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-actions {
            display: flex;
            gap: 10px;
        }

        .contact-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .contact-btn.chat {
            background: #00a884;
            color: white;
        }

        .contact-btn.remove {
            background: #667781;
            color: white;
        }

        .contact-btn:hover {
            opacity: 0.8;
        }

        /* Add Contact Section */
        .add-contact-section {
            padding: 16px;
            background: #202c33;
            border-bottom: 1px solid #2a3942;
        }

        .add-contact-input {
            display: flex;
            gap: 10px;
        }

        .add-contact-input input {
            flex: 1;
            padding: 10px;
            background: #2a3942;
            border: 1px solid #374045;
            border-radius: 8px;
            color: #e9edef;
            font-size: 14px;
        }

        .add-contact-input button {
            padding: 10px 20px;
            background: #00a884;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        /* Main Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0b141a;
        }

        .chat-header {
            background: #202c33;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            border-left: 1px solid #2a3942;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-header-details {
            display: flex;
            flex-direction: column;
        }

        .chat-header-name {
            color: #e9edef;
            font-size: 16px;
            font-weight: 500;
        }

        .chat-header-status {
            color: #8696a0;
            font-size: 13px;
        }

        .typing-indicator {
            color: #00a884;
            font-size: 13px;
            font-style: italic;
        }

        /* Messages Area */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='grid' width='100' height='100' patternUnits='userSpaceOnUse'%3E%3Crect width='100' height='100' fill='%230b141a'/%3E%3Cpath d='M 50 0 L 50 100' stroke='%23151f27' stroke-width='0.5' opacity='0.5'/%3E%3Cpath d='M 0 50 L 100 50' stroke='%23151f27' stroke-width='0.5' opacity='0.5'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23grid)'/%3E%3C/svg%3E");
        }

        .message {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 8px;
            word-wrap: break-word;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
            background: #005c4b;
            color: #e9edef;
        }

        .message.received {
            align-self: flex-start;
            background: #202c33;
            color: #e9edef;
        }

        .message-sender {
            font-size: 12px;
            color: #8bb3f4;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .message-text {
            margin-bottom: 4px;
        }

        .message-file {
            margin: 8px 0;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .message-file:hover {
            background: rgba(0,0,0,0.3);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-icon {
            font-size: 20px;
        }

        .file-name {
            color: #8bb3f4;
            text-decoration: none;
            word-break: break-all;
        }

        .file-size {
            color: #8696a0;
            font-size: 12px;
        }

        .message-image {
            max-width: 100%;
            border-radius: 6px;
            margin-top: 8px;
            cursor: pointer;
        }

        .message-meta {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: #8696a0;
            margin-top: 2px;
        }

        /* Message Input */
        .message-input-container {
            background: #202c33;
            padding: 10px 16px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
            border-top: 1px solid #2a3942;
        }

        .attachment-preview {
            display: none;
            padding: 10px;
            background: #111b21;
            border-radius: 8px;
            margin-bottom: 10px;
            align-items: center;
            gap: 10px;
        }

        .attachment-preview.active {
            display: flex;
        }

        .preview-info {
            flex: 1;
            color: #e9edef;
        }

        .message-input {
            flex: 1;
            background: #2a3942;
            border: none;
            color: #e9edef;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 15px;
            resize: none;
            min-height: 20px;
            max-height: 100px;
            outline: none;
        }

        .send-btn {
            background: #00a884;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
        }

        /* Empty State */
        .empty-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #667781;
            text-align: center;
            padding: 20px;
        }

        .loading {
            text-align: center;
            color: #8696a0;
            padding: 40px;
            font-size: 16px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 10;
            }
            
            .sidebar.hidden {
                display: none;
            }
            
            .chat-main {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="auth-screen" id="authScreen">
        <div class="auth-box">
            <h1>🔐 Secure WhatsApp</h1>
            <p id="authTitle">Sign in to your account</p>
            
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            
            <input type="text" id="usernameInput" placeholder="Username" maxlength="20">
            <input type="password" id="passwordInput" placeholder="Password">
            <input type="password" id="confirmPasswordInput" placeholder="Confirm Password" style="display:none;">
            
            <button id="authBtn" onclick="handleAuth()">Sign In</button>
            
            <p>
                <span id="authSwitchText">Don't have an account?</span>
                <span class="auth-switch" id="authSwitch" onclick="toggleAuthMode()">Sign Up</span>
            </p>
        </div>
    </div>

    <div class="chat-screen" id="chatScreen">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-name" id="userName">User</div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" title="Logout" onclick="logout()">🚪</button>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" id="chatsTab" onclick="showChats()">Chats</button>
                <button class="tab" id="contactsTab" onclick="showContacts()">Contacts</button>
            </div>
            
            <div class="chat-list" id="chatList">
                <div class="loading">No chats yet. Add contacts to start chatting!</div>
            </div>
            
            <div class="contacts-list" id="contactsList">
                <div class="add-contact-section">
                    <div class="add-contact-input">
                        <input type="text" id="addContactInput" placeholder="Enter username to add">
                        <button onclick="addContact()">Add</button>
                    </div>
                </div>
                <div id="contactsContainer">
                    <div class="loading">No contacts yet. Add someone to start chatting!</div>
                </div>
            </div>
        </div>

        <div class="chat-main" id="chatMain">
            <div class="empty-chat" id="emptyChat">
                <div style="font-size: 100px;">🔐</div>
                <h2>Secure Messaging</h2>
                <p>Your messages are private. Only your contacts can message you.</p>
                <p>Add contacts to start secure conversations.</p>
            </div> 
            <div id="activeChat" style="display: none; flex: 1; flex-direction: column;">
                <div class="chat-header">
                    <div class="chat-header-info">
                        <button class="icon-btn" onclick="toggleSidebar()">☰</button>
                        <div class="chat-avatar" id="chatAvatar">
                            <span id="chatAvatarText">U</span>
                            </div>
                        <div class="chat-header-details">
                            <div class="chat-header-name" id="chatName">Select a chat</div>
                            <div class="chat-header-status" id="chatStatus">offline</div>
                        </div>
                    </div>
                </div>
                <div class="messages-container" id="messagesContainer"></div>
                <div class="message-input-container">
                    <div style="flex: 1;">
                        <div class="attachment-preview" id="attachmentPreview">
                            <div class="preview-info">
                                <div id="previewName"></div>
                                <div style="font-size: 12px; color: #8696a0;" id="previewSize"></div>
                            </div>
                            <button class="contact-btn remove" onclick="removeAttachment()">Remove</button>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <button class="icon-btn" onclick="document.getElementById('fileInput').click()" title="Attach file">📎</button>
                            <input type="file" id="fileInput" style="display:none;" onchange="handleFileSelect(event)" accept="image/*,application/pdf,.doc,.docx,.txt,.zip,.mp4,.mp3">
                            <textarea class="message-input" id="messageInput" placeholder="Type a message" rows="1" onkeypress="handleKeyPress(event)" oninput="handleTyping(); autoResize(this)" ></textarea>
                            <button class="send-btn" onclick="sendMessage()">➤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> 

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        let authToken = null;
        let currentUser = null;
        let currentChatId = null;
        let currentChatTarget = null; // Store the username of the other participant
        let chats = new Map();
        let chatsPagination = new Map(); // NEW: { chatId: { offset: number, hasMore: boolean } }
        let isFetchingOlderMessages = false; // NEW: Throttle flag
        let contacts = [];
        let typingTimeout = null;
        let isTyping = false;
        let selectedFile = null;
        let isLoginMode = true;
        const MESSAGE_LOAD_LIMIT = 50; // Must match server.js limit

        // --- CORE FIX: Use sessionStorage for tab-specific session ---
        window.addEventListener('load', () => {
            const savedToken = sessionStorage.getItem('authToken');
            if (savedToken) {
                authToken = savedToken;
                initSocket();
            }
        });

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const title = document.getElementById('authTitle');
            const btn = document.getElementById('authBtn');
            const switchText = document.getElementById('authSwitchText');
            const switchBtn = document.getElementById('authSwitch');
            const confirmInput = document.getElementById('confirmPasswordInput');
            
            if (isLoginMode) {
                title.textContent = 'Sign in to your account';
                btn.textContent = 'Sign In';
                switchText.textContent = "Don't have an account?";
                switchBtn.textContent = 'Sign Up';
                confirmInput.style.display = 'none';
            } else {
                title.textContent = 'Create a new account';
                btn.textContent = 'Sign Up';
                switchText.textContent = 'Already have an account?';
                switchBtn.textContent = 'Sign In';
                confirmInput.style.display = 'block';
            }
            clearMessages();
        }

        function clearMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        async function handleAuth() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const confirmPassword = document.getElementById('confirmPasswordInput').value;

            if (!username || !password) {
                showError('Please enter username and password');
                return;
            }

            if (!isLoginMode && password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            const endpoint = isLoginMode ? '/api/login' : '/api/register';

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    sessionStorage.setItem('authToken', authToken); // <-- FIX: Use sessionStorage
                    
                    if (!isLoginMode) {
                        showSuccess('Account created successfully! Logging you in...');
                        setTimeout(() => {
                            initSocket();
                        }, 1500);
                    } else {
                        initSocket();
                    }
                } else {
                    showError(data.error || 'Authentication failed');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            }
        }

        function logout() {
            socket.disconnect();
            sessionStorage.removeItem('authToken'); // <-- FIX: Use sessionStorage
            currentUser = null;
            currentChatId = null;
            chats = new Map();
            chatsPagination = new Map(); // Clear pagination state
            contacts = [];
            
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('chatScreen').style.display = 'none';
            document.getElementById('usernameInput').value = '';
            document.getElementById('passwordInput').value = '';
            document.getElementById('confirmPasswordInput').value = '';
            clearMessages();
            document.getElementById('chatList').innerHTML = '<div class="loading">No chats yet. Add contacts to start chatting!</div>';
            showEmptyChat();
            console.log("Logged out.");
        }

        function initSocket() {
            if (socket) {
                socket.disconnect();
            }
            
            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true
            });

            socket.on('connect', () => {
                console.log('Socket connected, authenticating...');
                socket.emit('authenticate', { token: authToken });
            });

            socket.on('auth-success', (data) => {
                console.log('Authentication successful');
                currentUser = data;
                
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('chatScreen').style.display = 'flex';
                
                document.getElementById('userName').textContent = currentUser.username;
                document.getElementById('userAvatar').textContent = currentUser.username.charAt(0).toUpperCase();

                renderChats(data.chats);
                
                // Fetch contacts after auth
                getContacts();
                
                // If a chat was active before refresh, try to re-open it
                if (currentChatTarget) {
                    const existingChat = Array.from(chats.values()).find(c => c.name === currentChatTarget);
                    if (existingChat) {
                        selectChat(existingChat);
                    } else {
                        // If no chat object, try to start new chat (e.g., first chat attempt)
                        socket.emit('start-chat', { targetUsername: currentChatTarget });
                    }
                } else {
                    showEmptyChat();
                }
            });

            socket.on('auth-failed', (data) => {
                console.error('Authentication failed:', data.error);
                logout();
                showError(data.error);
            });

            socket.on('contacts-list', (data) => {
                contacts = data.contacts;
                renderContacts(contacts);
            });

            socket.on('contact-added', (data) => {
                contacts.push(data);
                renderContacts(contacts);
                showSuccess(`Contact ${data.username} added!`);
            });

            socket.on('contact-removed', (data) => {
                contacts = contacts.filter(c => c.username !== data.username);
                renderContacts(contacts);
                showSuccess(`Contact ${data.username} removed!`);
                // Close chat if it was open
                if (currentChatTarget === data.username) {
                    currentChatId = null;
                    currentChatTarget = null;
                    showEmptyChat();
                }
            });

            socket.on('contact-online', (data) => {
                updateContactStatus(data.username, true);
                updateChatStatus(data.username, true);
            });

            socket.on('contact-offline', (data) => {
                updateContactStatus(data.username, false);
                updateChatStatus(data.username, false);
            });

            socket.on('new-chat', (data) => {
                chats.set(data.chatId, data);
                renderChats(Array.from(chats.values()));
            });

            socket.on('chat-started', (data) => {
                chats.set(data.chatId, data);
                // The messages will be loaded in selectChat, so no need to call displayMessages here
                // Instead, ensure selectChat is called correctly
                const chat = chats.get(data.chatId);
                if (chat) {
                    selectChat(chat); 
                }
            });

            socket.on('new-message', (data) => {
                const { chatId, message } = data;
                
                if (chatId === currentChatId) {
                    appendMessage(message);
                    scrollToBottom();
                }
                
                updateChatListItem(chatId, message);
            });

            socket.on('user-typing', (data) => {
                if (data.chatId === currentChatId && data.username === currentChatTarget) {
                    document.getElementById('chatStatus').textContent = data.isTyping ? 'typing...' : (chats.get(currentChatId).online ? 'online' : 'offline');
                }
            });

            // UPDATED: Initial message load handler
            socket.on('messages-loaded', (data) => {
                const { chatId, messages, totalMessages, hasMore } = data;
                if (chatId === currentChatId) {
                    displayMessages(messages);
                    
                    // Update pagination state
                    chatsPagination.set(chatId, { 
                        offset: messages.length, 
                        hasMore: hasMore
                    });
                    
                    // Scroll to bottom only on initial load
                    scrollToBottom();
                }
            });

            // NEW: Older messages loaded handler
            socket.on('older-messages-loaded', (data) => {
                const { chatId, messages, offset, hasMore } = data;
                if (chatId === currentChatId) {
                    prependMessages(messages);
                    
                    // Update pagination state
                    chatsPagination.set(chatId, { 
                        offset: offset, 
                        hasMore: hasMore
                    });
                }
            });

            socket.on('chat-error', (data) => {
                console.error('Chat Error:', data.error);
                alert('Chat Error: ' + data.error);
            });

            socket.on('disconnect', () => {
                console.log('Socket disconnected');
            });
        }

        // --- NEW SCROLL AND PAGINATION FUNCTIONS ---
        
        function handleScroll(event) {
            const container = event.target;
            const pagination = chatsPagination.get(currentChatId);

            // Check if user scrolled to the very top (within 5 pixels for browser variations)
            if (container.scrollTop <= 5 && pagination && pagination.hasMore && !isFetchingOlderMessages) {
                console.log('Scrolled to top. Fetching older messages...');
                isFetchingOlderMessages = true;
                
                // Show a loading indicator at the top
                container.insertAdjacentHTML('afterbegin', '<div id="loadingOlder" class="loading" style="padding: 10px; font-size: 14px;">Loading older messages...</div>');

                socket.emit('get-older-messages', {
                    chatId: currentChatId,
                    offset: pagination.offset
                });
            }
        }
        
        function prependMessages(messages) {
            const container = document.getElementById('messagesContainer');
            const loadingIndicator = document.getElementById('loadingOlder');
            const oldScrollHeight = container.scrollHeight;
            
            // Remove the loading indicator
            if (loadingIndicator) {
                loadingIndicator.remove();
            }

            if (messages.length === 0) {
                 container.insertAdjacentHTML('afterbegin', '<div class="loading" style="padding: 10px; font-size: 14px;">No more messages</div>');
                 isFetchingOlderMessages = false;
                 return;
            }

            // Prepend messages in reverse order to maintain chronological order in the array
            messages.reverse().forEach(message => {
                const messageEl = createMessageElement(message);
                container.prepend(messageEl);
            });
            
            // Adjust scroll position to maintain view (the scroll height has increased by the height of the new messages)
            const newScrollHeight = container.scrollHeight;
            container.scrollTop = newScrollHeight - oldScrollHeight;
            
            isFetchingOlderMessages = false;
        }

        // --- OLDER UTILITY FUNCTIONS (Modified to support the new structure) ---
        
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container) {
                // Use smooth behavior for a better UX
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            }
        }
        
        function updateChatListItem(chatId, message) {
            const chatItem = document.getElementById(`chat-item-${chatId}`);
            if (chatItem) {
                const chat = chats.get(chatId);
                if (chat) {
                    const lastMessageElement = chatItem.querySelector('.chat-last-message');
                    if (lastMessageElement) {
                        let previewText = message.text || (message.file ? getFileIcon(message.file.mimetype) + ' ' + message.file.originalName : 'File');
                        
                        if (message.senderUsername !== currentUser.username) {
                            previewText = `${message.senderUsername}: ${previewText}`;
                        } else {
                            previewText = `You: ${previewText}`;
                        }
                        
                        lastMessageElement.textContent = previewText;
                    }

                    const chatList = document.getElementById('chatList');
                    if (chatList && chatItem !== chatList.firstElementChild) {
                        chatList.prepend(chatItem);
                    }
                }
            }
        }
        
        function createMessageElement(message) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${message.sent ? 'sent' : 'received'}`;

            const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let messageContent = `<div class="message-text">${escapeHtml(message.text)}</div>`;

            if (message.file) {
                const isImage = message.file.mimetype.startsWith('image/');
                const isVideo = message.file.mimetype.startsWith('video/');

                if (isImage) {
                    messageContent += `<img class="message-image" src="${message.file.url}" alt="Image" onclick="window.open('${message.file.url}', '_blank')">`;
                } else if (isVideo) {
                    messageContent += `<video class="message-image" controls src="${message.file.url}" onclick="window.open('${message.file.url}', '_blank')"></video>`;
                } else {
                    messageContent += `
                        <a href="${message.file.url}" target="_blank" class="message-file">
                            <div class="file-info">
                                <span class="file-icon">${getFileIcon(message.file.mimetype)}</span>
                                <div>
                                    <div class="file-name">${message.file.originalName}</div>
                                    <div class="file-size">${formatBytes(message.file.size)}</div>
                                </div>
                            </div>
                        </a>
                    `;
                }
            }
            
            messageEl.innerHTML = `
                ${messageContent}
                <div class="message-meta">${time}</div>
            `;
            return messageEl;
        }

        function appendMessage(message) {
            const container = document.getElementById('messagesContainer');
            const messageEl = createMessageElement(message);
            container.appendChild(messageEl);
        }
        
        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = ''; // Clear container
            messages.forEach(msg => {
                const messageEl = createMessageElement(msg);
                container.appendChild(messageEl);
            });
        }

        function renderChats(chatsArray) {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';

            if (chatsArray.length === 0) {
                chatList.innerHTML = '<div class="loading">No chats yet. Add contacts to start chatting!</div>';
                return;
            }

            chatsArray.sort((a, b) => (b.lastMessage ? b.lastMessage.time : 0) - (a.lastMessage ? a.lastMessage.time : 0));

            chatsArray.forEach(chat => {
                const otherParticipant = chat.participants.find(p => p !== currentUser.username);
                if (!otherParticipant) return; 

                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${chat.chatId === currentChatId ? 'active' : ''}`;
                chatItem.id = `chat-item-${chat.chatId}`;
                chatItem.onclick = () => selectChat(chat);
                
                let lastMsgText = chat.lastMessage ? (chat.lastMessage.text || (chat.lastMessage.file ? getFileIcon(chat.lastMessage.file.mimetype) + ' ' + chat.lastMessage.file.originalName : 'File')) : 'Start chatting!';
                
                if (chat.lastMessage) {
                    if (chat.lastMessage.senderUsername === currentUser.username) {
                         lastMsgText = `You: ${lastMsgText}`;
                    } else {
                         lastMsgText = `${chat.lastMessage.senderUsername}: ${lastMsgText}`;
                    }
                }

                chatItem.innerHTML = `
                    <div class="chat-avatar" id="chat-avatar-${chat.chatId}">
                        <span id="chat-avatar-text-${chat.chatId}">${otherParticipant.charAt(0).toUpperCase()}</span>
                        <span class="online-indicator" id="online-indicator-${otherParticipant}" style="display: ${chat.online ? 'block' : 'none'};"></span>
                    </div>
                    <div class="chat-details">
                        <div class="chat-name">${otherParticipant}</div>
                        <div class="chat-last-message">${lastMsgText}</div>
                    </div>
                `;
                chatList.appendChild(chatItem);

                chats.set(chat.chatId, { ...chat, name: otherParticipant });
            });
        }

        function renderContacts(contactsArray) {
            const contactsContainer = document.getElementById('contactsContainer');
            contactsContainer.innerHTML = '';

            if (contactsArray.length === 0) {
                contactsContainer.innerHTML = '<div class="loading">No contacts yet. Add someone to start chatting!</div>';
                return;
            }

            contactsArray.forEach(contact => {
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                contactItem.id = `contact-item-${contact.username}`;
                
                const onlineDisplay = contact.online ? 'block' : 'none';

                contactItem.innerHTML = `
                    <div class="contact-avatar">
                        <span>${contact.username.charAt(0).toUpperCase()}</span>
                        <span class="online-indicator" id="contact-online-indicator-${contact.username}" style="display: ${onlineDisplay};"></span>
                    </div>
                    <div class="contact-details">
                        <div class="contact-name">${contact.username}</div>
                        <div class="contact-status" id="contact-status-${contact.username}">${contact.online ? 'Online' : 'Offline'}</div>
                    </div>
                    <div class="contact-actions">
                        <button class="contact-btn chat" onclick="startChat('${contact.username}')">Chat</button>
                    </div>
                `;
                contactsContainer.appendChild(contactItem);
            });
        }

        function selectChat(chat) {
            if (currentChatId) {
                const prevChatEl = document.getElementById(`chat-item-${currentChatId}`);
                if (prevChatEl) prevChatEl.classList.remove('active');
            }
            
            // Set new active chat state
            currentChatId = chat.chatId;
            currentChatTarget = chat.name;
            
            // Update UI elements
            const newChatEl = document.getElementById(`chat-item-${currentChatId}`);
            if (newChatEl) newChatEl.classList.add('active');
            
            document.getElementById('emptyChat').style.display = 'none';
            document.getElementById('activeChat').style.display = 'flex';
            
            document.getElementById('chatName').textContent = chat.name;
            document.getElementById('chatAvatarText').textContent = chat.name.charAt(0).toUpperCase();
            
            const chatHeaderAvatar = document.querySelector('#activeChat .chat-avatar');
            if (chatHeaderAvatar) {
                let onlineIndicator = chatHeaderAvatar.querySelector('.online-indicator');
                if (!onlineIndicator) {
                    onlineIndicator = document.createElement('span');
                    onlineIndicator.className = 'online-indicator';
                    onlineIndicator.id = 'chat-header-online-indicator';
                    chatHeaderAvatar.appendChild(onlineIndicator);
                }
                onlineIndicator.style.display = chat.online ? 'block' : 'none';
            }
            document.getElementById('chatStatus').textContent = chat.online ? 'online' : 'offline';
            
            // Clear message container and request messages
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '<div class="loading">Loading messages...</div>';
            
            // Attach scroll handler
            messagesContainer.onscroll = handleScroll;

            // Reset/Initialize pagination state
            chatsPagination.set(chat.chatId, { offset: 0, hasMore: true });

            // Request initial message batch
            socket.emit('get-messages', { chatId: currentChatId });
            
            // Hide sidebar on mobile
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.add('hidden');
            }
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();

            if (!currentChatId || (!text && !selectedFile)) {
                return;
            }

            let fileInfo = null;
            let finalMessageText = text;

            // 1. Handle File Upload if present
            if (selectedFile) {
                try {
                    const uploadResponse = await uploadFile(selectedFile);
                    if (uploadResponse.success) {
                        fileInfo = uploadResponse.file;
                        // Use a default text if only a file is being sent
                        if (!text) finalMessageText = fileInfo.originalName;
                    } else {
                        showError(uploadResponse.error || 'File upload failed');
                        return;
                    }
                } catch (error) {
                    showError('Error during file upload: ' + error.message);
                    return;
                }
            }

            // 2. Send the message
            socket.emit('send-message', { 
                chatId: currentChatId, 
                text: finalMessageText, 
                file: fileInfo 
            });

            // 3. Clean up
            messageInput.value = '';
            messageInput.style.height = '20px'; // Reset textarea height
            removeAttachment();
            
            // Stop typing indicator instantly after sending
            if (isTyping) {
                socket.emit('typing', { chatId: currentChatId, isTyping: false });
                isTyping = false;
            }
        }
        
        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            // Use the standard Authorization header pattern
            const response = await fetch('/api/upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}` 
                },
                body: formData
            });

            return response.json();
        }

        // --- CONTACT/CHAT ACTIONS ---

        function startChat(targetUsername) {
            const existingChat = Array.from(chats.values()).find(c => c.name === targetUsername);
            if (existingChat) {
                selectChat(existingChat);
            } else {
                // Save the target, in case the server needs to reload the page or if the user refreshes
                currentChatTarget = targetUsername;
                socket.emit('start-chat', { targetUsername });
            }
            
            // Switch to chats tab
            showChats();
        }

        async function addContact() {
            const input = document.getElementById('addContactInput');
            const contactUsername = input.value.trim();

            if (!contactUsername) {
                alert('Please enter a username to add.');
                return;
            }

            try {
                // Use the standard Authorization header pattern
                const response = await fetch('/api/add-contact', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}` 
                    },
                    body: JSON.stringify({ contactUsername })
                });

                const data = await response.json();

                if (response.ok) {
                    input.value = '';
                    // The socket event 'contact-added' will handle UI update
                } else {
                    showError(data.error || 'Failed to add contact');
                }
            } catch (error) {
                showError('Network error. Failed to add contact.');
            }
        }
        
        function getContacts() {
             socket.emit('get-contacts'); 
        }

        // --- TYPING INDICATOR AND UI ---

        function handleTyping() {
            if (!currentChatId) return;

            // Handle the input for the message input container to auto-resize
            autoResize(document.getElementById('messageInput'));

            if (!isTyping) {
                isTyping = true;
                socket.emit('typing', { chatId: currentChatId, isTyping: true });
            }

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                isTyping = false;
                socket.emit('typing', { chatId: currentChatId, isTyping: false });
            }, 3000); 
        }

        function autoResize(element) {
            element.style.height = 'auto';
            element.style.height = (element.scrollHeight) + 'px';
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        function updateContactStatus(username, isOnline) {
            const contactStatusEl = document.getElementById(`contact-status-${username}`);
            const contactIndicatorEl = document.getElementById(`contact-online-indicator-${username}`);
            
            if (contactStatusEl) contactStatusEl.textContent = isOnline ? 'Online' : 'Offline';
            if (contactIndicatorEl) contactIndicatorEl.style.display = isOnline ? 'block' : 'none';
            
            const chatOnlineIndicator = document.getElementById(`online-indicator-${username}`);
            if (chatOnlineIndicator) chatOnlineIndicator.style.display = isOnline ? 'block' : 'none';

            const chat = Array.from(chats.values()).find(c => c.name === username);
            if (chat) chat.online = isOnline;
        }

        function updateChatStatus(username, isOnline) {
            if (currentChatTarget === username) {
                const statusEl = document.getElementById('chatStatus');
                statusEl.textContent = isOnline ? 'online' : 'offline';

                const chatHeaderAvatar = document.querySelector('#activeChat .chat-avatar');
                if (chatHeaderAvatar) {
                    const onlineIndicator = document.getElementById('chat-header-online-indicator');
                    if (onlineIndicator) onlineIndicator.style.display = isOnline ? 'block' : 'none';
                }
            }
        }
        
        function toggleSidebar() {
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.toggle('hidden');
            }
        }
        
        function showChats() {
            document.getElementById('chatsTab').classList.add('active');
            document.getElementById('contactsTab').classList.remove('active');
            document.getElementById('chatList').classList.remove('hidden');
            document.getElementById('contactsList').classList.remove('active');
        }

        function showContacts() {
            document.getElementById('chatsTab').classList.remove('active');
            document.getElementById('contactsTab').classList.add('active');
            document.getElementById('chatList').classList.add('hidden');
            document.getElementById('contactsList').classList.add('active');
        }

        function showEmptyChat() {
            document.getElementById('emptyChat').style.display = 'flex';
            document.getElementById('activeChat').style.display = 'none';
            document.getElementById('chatName').textContent = 'Select a chat';
            document.getElementById('chatStatus').textContent = 'offline';
        }

        // --- FILE HANDLING ---

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                alert('File size exceeds the 10MB limit.');
                removeAttachment();
                return;
            }

            selectedFile = file;
            const preview = document.getElementById('attachmentPreview');
            document.getElementById('previewName').textContent = file.name;
            document.getElementById('previewSize').textContent = formatBytes(file.size);
            
            preview.classList.add('active');
        }

        function removeAttachment() {
            selectedFile = null;
            document.getElementById('fileInput').value = ''; // Clear file input
            document.getElementById('attachmentPreview').classList.remove('active');
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function getFileIcon(mimetype) {
            if (!mimetype) return '📎';
            if (mimetype.startsWith('image/')) return '🖼️';
            if (mimetype.startsWith('video/')) return '🎥';
            if (mimetype.startsWith('audio/')) return '🎵';
            if (mimetype.includes('pdf')) return '📄';
            if (mimetype.includes('zip') || mimetype.includes('compressed')) return '📦';
            if (mimetype.includes('doc')) return '📝';
            return '📎';
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Handle Enter key in auth inputs
        document.getElementById('usernameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAuth();
        });
        document.getElementById('passwordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAuth();
        });
        document.getElementById('confirmPasswordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAuth();
        });
        document.getElementById('addContactInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addContact();
        });
    </script>
</body>
</html>
